<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AOR 5357-23 Unit 102 v1</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #fff; color: #000; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  th, td { border: 1px solid #000; padding: 6px; vertical-align: top; }
  th { text-align: left; background: #f2f2f2; }
  tr.checked { background-color: #d9fdd3; }
  td.sub { padding-left: 30px; font-style: italic; }
  td.letter { width: 30px; text-align: center; }
  h2 { margin-top: 30px; }
  textarea, input[type=text] { width: 100%; box-sizing: border-box; }
  .photo-section, .feedback-section, .signature-section { margin-top: 20px; }
  .photo-card { border: 1px solid #000; padding: 10px; margin-top: 10px; }
  img { width: 100%; max-width: 100%; height: auto; display: block; margin-bottom: 8px; }
  .photo-card { width: 100%; }
  .photo-card input[type=text] { margin-top: 6px; }
  select { width: 100%; }
  canvas { border: 1px solid #000; width: 100%; height: 150px; }
  button { margin-top: 10px; padding: 6px 12px; }
</style>
<link href="manifest.webmanifest" rel="manifest"/><meta content="#000000" name="theme-color"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black" name="apple-mobile-web-app-status-bar-style"/><link href="icons/icon-180.png" rel="apple-touch-icon"/></head>
<body>
<h1>AOR 5357-23 Unit 102 v1</h1><h1>Assessor Observation Report – Unit 102</h1>
<!-- Section 1 -->
<table class="criteria-table">
<tr><th colspan="7">1 Apply relevant health &amp; safety legislation in the workplace.</th></tr>
<tr><th>Criteria</th><th>Sub</th><th>Description</th><th>Obs</th><th>WT</th><th>PE</th></tr>
<tr><td>1.1</td><td></td><td>Identify which workplace health and safety procedures are relevant to the working environment and comply with their duties and obligations as defined by current legislation and organisational procedures</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td>1.2</td><td></td><td>Produce a risk assessment and method statement in accordance with organisational procedures for a given work activity.</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td rowspan="4">1.3</td><td></td><td>Work within the requirements of:</td><td></td><td></td><td></td></tr>
<tr><td class="letter">a</td><td class="sub">Risk assessments</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">b</td><td class="sub">Method statements</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">c</td><td class="sub">Safe systems of work</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
</table>
<!-- Section 2 -->
<table class="criteria-table">
<tr><th colspan="7">2 Assess the work environment for hazards and identify remedial actions in accordance with Health and Safety legislation</th></tr>
<tr><th>Criteria</th><th>Sub</th><th>Description</th><th>Obs</th><th>WT</th><th>PE</th></tr>
<tr><td>2.1</td><td></td><td>Identify unsafe situations and conditions and take remedial actions</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td rowspan="4">2.2</td><td></td><td>Assess the work environment and revise work practices accordingly to take into account hazards which could cause harm, including the handling of potentially hazardous:</td><td></td><td></td><td></td></tr>
<tr><td class="letter">a</td><td class="sub">Materials</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">b</td><td class="sub">Tools</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">c</td><td class="sub">Equipment</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td>2.3</td><td></td><td>Identify any hazards which may present a high risk and report their presence to relevant persons who have overall responsibility for health and safety in the workplace</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td>2.4</td><td></td><td>Apply measures to control health and safety hazards.</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td>2.5</td><td></td><td>Select and use correct Personal Protective Equipment.</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
</table>
<!-- Section 3 -->
<table class="criteria-table">
<tr><th colspan="7">3 Apply methods and procedures to ensure work on site is in accordance with Health and Safety legislation</th></tr>
<tr><th>Criteria</th><th>Sub</th><th>Description</th><th>Obs</th><th>WT</th><th>PE</th></tr>
<tr><td>3.1</td><td></td><td>Demonstrate a level of personal conduct and behaviour within the workplace, to ensure that the health and safety of themselves and others is not endangered</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td rowspan="4">3.2</td><td></td><td>Apply procedures to ensure the safe use, maintenance and storage of tools, plant and equipment as stipulated in:</td><td></td><td></td><td></td></tr>
<tr><td class="letter">a</td><td class="sub">Workplace policies (company and site)</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">b</td><td class="sub">Supplier information</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">c</td><td class="sub">Manufacturer’s instructions</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td>3.3</td><td></td><td>Comply with hazard warning, mandatory instruction and prohibition notices</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td>3.4</td><td></td><td>Apply procedures to ensure the safety of the work location through the correct use of guards, barriers, and notices</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td rowspan="5">3.5</td><td></td><td>Use access equipment correctly<br/>Range – assess TWO from the following:</td><td></td><td></td><td></td></tr>
<tr><td class="letter">a</td><td class="sub">Ladder</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">b</td><td class="sub">Tower scaffold or MEWP</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">c</td><td class="sub">Stepladder</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">d</td><td class="sub">Platform</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
</table>
<!-- Section 4 -->
<table class="criteria-table">
<tr><th colspan="7">4 Be able to work in accordance with environmental legislation for electrical services.</th></tr>
<tr><th>Criteria</th><th>Sub</th><th>Description</th><th>Obs</th><th>WT</th><th>PE</th></tr>
<tr><td rowspan="7">4.1</td><td></td><td>Demonstrate appropriate procedures for the safe handling, storage &amp; disposal of hazardous materials &amp; products. (Cover one):</td><td></td><td></td><td></td></tr>
<tr><td class="letter">a</td><td class="sub">Environmental Protection Act</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">b</td><td class="sub">Hazardous Waste Regulations</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">c</td><td class="sub">Pollution Prevention &amp; Control Act</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">d</td><td class="sub">Control of Pollution Act</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">e</td><td class="sub">Control of Noise at Work Regulations</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
<tr><td class="letter">f</td><td class="sub">Environmental Act</td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td><td><input type="checkbox"/></td></tr>
</table>
<div class="photo-section">
<h2>Photo Evidence</h2>
<input accept="image/*" id="photoInput" multiple="" type="file"/><br/>
<div id="photoContainer"></div>
</div>
<div class="feedback-section">
<h2>Assessor Feedback</h2>
<textarea placeholder="Enter assessor feedback here..." rows="5"></textarea>
</div>
<div class="signature-section">
<h2>Signature</h2>
<canvas id="signature"></canvas><br/>
<button id="clearSig">Clear Signature</button>
</div><div class="controls">
<button id="saveDraft">Save Draft</button>
<button id="loadDraft">Load Draft</button>
<button id="clearDraft">Clear Draft</button>
<button id="exportPDF">Save / Export as PDF</button>
</div>
<script>
// Highlight checked rows
const tables = document.querySelectorAll('.criteria-table');
tables.forEach(table => {
  table.addEventListener('change', e => {
    if (e.target.type === 'checkbox') {
      const row = e.target.closest('tr');
      const anyChecked = row.querySelectorAll('input[type="checkbox"]:checked').length > 0;
      row.classList.toggle('checked', anyChecked);
    }
  });
});

// Photo upload handling
const photoInput = document.getElementById('photoInput');
const container = document.getElementById('photoContainer');
const criteriaOptions = ['1.1','1.2','1.3a','1.3b','1.3c','2.1','2.2a','2.2b','2.2c','2.3','2.4','2.5','3.1','3.2a','3.2b','3.2c','3.3','3.4','3.5a','3.5b','3.5c','3.5d','4.1a','4.1b','4.1c','4.1d','4.1e','4.1f'];

photoInput.addEventListener('change', e => {
  for (const file of e.target.files) {
    const reader = new FileReader();
    reader.onload = ev => {
      const div = document.createElement('div');
      div.className = 'photo-card';
      div.innerHTML = `<img src="${ev.target.result}" alt="Photo"><input type='text' placeholder='Caption'><br><label>Criteria: <select>${criteriaOptions.map(c => `<option>${c}</option>`).join('')}</select></label>`;
      container.appendChild(div);
    };
    reader.readAsDataURL(file);
  }
});

// Signature pad
const sigCanvas = document.getElementById('signature');
const ctx = sigCanvas.getContext('2d');
let drawing = false;

sigCanvas.addEventListener('mousedown', e => {drawing = true; ctx.moveTo(e.offsetX, e.offsetY);});
sigCanvas.addEventListener('mousemove', e => {if (drawing) {ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke();}});
window.addEventListener('mouseup', () => drawing = false);

document.getElementById('clearSig').addEventListener('click', () => ctx.clearRect(0, 0, sigCanvas.width, sigCanvas.height));
</script>
<script>
const STORAGE_KEY = 'obs-report-unit102';
const sigCanvas = document.getElementById('signature');
const ctx = sigCanvas.getContext('2d');

function collectData() {
  return {
    feedback: document.querySelector('textarea')?.value || '',
    signature: sigCanvas.toDataURL(),
    ticks: Array.from(document.querySelectorAll('input[type="checkbox"]')).map(cb => cb.checked),
    photos: Array.from(document.querySelectorAll('.photo-card img')).map(img => img.src)
  };
}

function applyData(data) {
  if (!data) return;
  document.querySelector('textarea').value = data.feedback || '';
  document.querySelectorAll('input[type="checkbox"]').forEach((cb, i) => cb.checked = !!data.ticks[i]);
  if (data.signature) {
    const img = new Image();
    img.onload = () => { ctx.clearRect(0, 0, sigCanvas.width, sigCanvas.height); ctx.drawImage(img, 0, 0); };
    img.src = data.signature;
  }
  if (data.photos) {
    const container = document.getElementById('photoContainer');
    container.innerHTML = '';
    data.photos.forEach(src => {
      const div = document.createElement('div');
      div.className = 'photo-card';
      div.innerHTML = `<img src="${src}" alt="Photo"><input type='text' placeholder='Caption'><br>`;
      container.appendChild(div);
    });
  }
}

document.getElementById('saveDraft').addEventListener('click', () => {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(collectData()));
  alert('Draft saved');
});

document.getElementById('loadDraft').addEventListener('click', () => {
  const data = localStorage.getItem(STORAGE_KEY);
  if (data) applyData(JSON.parse(data));
});

document.getElementById('clearDraft').addEventListener('click', () => {
  localStorage.removeItem(STORAGE_KEY);
  alert('Draft cleared');
});

document.getElementById('exportPDF').addEventListener('click', () => window.print());
</script>
<script>
(function(){
  // --- Trim to three checkbox columns (Obs, WT, PE) ---
  const tables = document.querySelectorAll('.criteria-table');
  tables.forEach(tbl => {
    // Remove any OTJ header
    tbl.querySelectorAll('th').forEach(th => {
      if ((th.textContent || '').toLowerCase().includes('otj')) th.remove();
    });
    // Remove extra checkbox cells in each row
    tbl.querySelectorAll('tr').forEach(tr => {
      const cells = Array.from(tr.children);
      const cbCells = cells.map((td)=>td).filter(td => td.querySelector && td.querySelector('input[type="checkbox"]'));
      if (cbCells.length > 3) {
        const extras = cbCells.slice(0, cbCells.length - 3);
        extras.forEach(td => td.remove());
      }
    });
  });

  // --- Photo delete buttons ---
  const container = document.getElementById('photoContainer');
  if (container) {
    // Add delete button to existing cards
    container.querySelectorAll('.photo-card').forEach(card => {
      if (!card.querySelector('.delete-photo')) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'delete-photo';
        btn.textContent = 'Delete photo';
        card.appendChild(btn);
      }
    });
    // Delegate
    container.addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('delete-photo')) {
        const card = e.target.closest('.photo-card');
        if (card && confirm('Remove this photo?')) card.remove();
      }
    });
    // Patch upload handler to add delete buttons to new cards
    const input = document.getElementById('photoInput');
    if (input) {
      input.addEventListener('change', () => {
        setTimeout(() => {
          container.querySelectorAll('.photo-card').forEach(card => {
            if (!card.querySelector('.delete-photo')) {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'delete-photo';
              btn.textContent = 'Delete photo';
              card.appendChild(btn);
            }
          });
        }, 60);
      }, { capture: true });
    }
  }

  // --- Signature touch support for iPad ---
  const sigCanvas = document.getElementById('signature');
  if (sigCanvas && sigCanvas.getContext) {
    const ctx = sigCanvas.getContext('2d');
    let drawing = false;

    // if mouse listeners not already bound, bind them
    if (!sigCanvas.__touchBound) {
      function getTouchPos(canvasDom, touchEvent) {
        const rect = canvasDom.getBoundingClientRect();
        const t = touchEvent.touches[0] || touchEvent.changedTouches[0];
        return { x: t.clientX - rect.left, y: t.clientY - rect.top };
      }
      sigCanvas.addEventListener('touchstart', function(e){
        e.preventDefault();
        const p = getTouchPos(sigCanvas, e);
        drawing = true;
        ctx.moveTo(p.x, p.y);
      }, {passive:false});
      sigCanvas.addEventListener('touchmove', function(e){
        e.preventDefault();
        if (!drawing) return;
        const p = getTouchPos(sigCanvas, e);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
      }, {passive:false});
      sigCanvas.addEventListener('touchend', function(e){
        e.preventDefault();
        drawing = false;
      }, {passive:false});
      sigCanvas.__touchBound = true;
    }
  }

  // --- Improve Save Draft alert & add fallback ---
  const saveBtn = document.getElementById('saveDraft');
  if (saveBtn) {
    const STORAGE_KEY = 'obs-report-unit102';
    function collectData() {
      const feedbackEl = document.getElementById('feedback') || document.querySelector('textarea');
      const container = document.getElementById('photoContainer');
      const sigCanvas = document.getElementById('signature');
      return {
        feedback: feedbackEl ? feedbackEl.value : '',
        signature: sigCanvas ? sigCanvas.toDataURL() : '',
        ticks: Array.from(document.querySelectorAll('input[type="checkbox"]')).map(cb=>cb.checked),
        photos: container ? Array.from(container.querySelectorAll('img')).map(img=>img.src) : []
      };
    }
    saveBtn.addEventListener('click', () => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(collectData()));
        alert('Draft saved locally — reopen this page later to continue.');
      } catch (err) {
        window.tempDraft = collectData();
        alert('Draft temporarily saved for this session — keep this tab open to retain changes.');
      }
    }, {capture:true});
  }
})();
</script>
<style>
.criteria-picker { margin-top: 8px; }
.criteria-panel { border: 1px solid #000; padding: 8px; margin-top: 6px; max-height: 220px; overflow: auto; display: none; background:#fff; }
.criteria-panel.open { display: block; }
.criteria-list label { display: block; margin-bottom: 4px; cursor: pointer; }
.criteria-tags { margin-top: 6px; display: flex; flex-wrap: wrap; gap: 6px; }
.criteria-tag { border: 1px solid #000; padding: 2px 6px; font-size: 12px; border-radius: 4px; }
.criteria-actions { margin-top: 8px; display:flex; gap:8px; }
.photo-card .controls-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
</style>
<script>
(function(){
  // --- Full criteria (id + text) ---
  const CRITERIA = [
    {id:'1.1', text:'Identify which workplace health and safety procedures are relevant and comply with duties and obligations as defined by current legislation and organisational procedures'},
    {id:'1.2', text:'Produce a risk assessment and method statement in accordance with organisational procedures for a given work activity'},
    {id:'1.3a', text:'Risk assessments'}, {id:'1.3b', text:'Method statements'}, {id:'1.3c', text:'Safe systems of work'},
    {id:'2.1', text:'Identify unsafe situations and conditions and take remedial actions'},
    {id:'2.2a', text:'Materials'}, {id:'2.2b', text:'Tools'}, {id:'2.2c', text:'Equipment'},
    {id:'2.3', text:'Identify any high-risk hazards and report to relevant persons responsible for H&S'},
    {id:'2.4', text:'Apply measures to control health and safety hazards'},
    {id:'2.5', text:'Select and use correct Personal Protective Equipment'},
    {id:'3.1', text:'Demonstrate conduct/behaviour so H&S of self and others is not endangered'},
    {id:'3.2a', text:'Workplace policies (company and site)'}, {id:'3.2b', text:'Supplier information'}, {id:'3.2c', text:\"Manufacturer's instructions\"},
    {id:'3.3', text:'Comply with hazard warning, mandatory instruction and prohibition notices'},
    {id:'3.4', text:'Ensure safety of work location through correct use of guards, barriers, and notices'},
    {id:'3.5a', text:'Ladder'}, {id:'3.5b', text:'Tower scaffold or MEWP'}, {id:'3.5c', text:'Stepladder'}, {id:'3.5d', text:'Platform'},
    {id:'4.1a', text:'Environmental Protection Act'}, {id:'4.1b', text:'Hazardous Waste Regulations'}, {id:'4.1c', text:'Pollution Prevention & Control Act'},
    {id:'4.1d', text:'Control of Pollution Act'}, {id:'4.1e', text:'Control of Noise at Work Regulations'}, {id:'4.1f', text:'Environmental Act'}
  ];

  function buildCriteriaPanel(selected=[]) {
    const list = CRITERIA.map(c => {
      const chk = selected.includes(c.id) ? 'checked' : '';
      return `<label><input type="checkbox" value="${c.id}" ${chk}> ${c.id} – ${c.text}</label>`;
    }).join('');
    return `
      <div class="criteria-actions">
        <button type="button" class="toggle-criteria">Select criteria</button>
        <span class="criteria-hint" style="font-size:12px;">Tick all that apply</span>
      </div>
      <div class="criteria-panel">
        <div class="criteria-list">${list}</div>
        <div class="criteria-actions">
          <button type="button" class="done-criteria">Done</button>
          <button type="button" class="clear-criteria">Clear</button>
        </div>
      </div>
      <div class="criteria-tags"></div>
    `;
  }

  function updateTags(panel, tagsBox) {
    const sel = Array.from(panel.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
    const items = sel.map(id => {
      const c = CRITERIA.find(x => x.id === id);
      return `<span class="criteria-tag">${id} – ${c ? c.text : ''}</span>`;
    }).join('');
    tagsBox.innerHTML = items;
  }

  function enhancePhotoCard(card, preset={}) {
    if (card.__enhanced) return;
    card.__enhanced = true;
    const img = card.querySelector('img');
    const src = img ? img.src : '';
    // Capture any existing caption if present
    const existingCaptionInput = card.querySelector('input[type="text"]');
    const existingCaption = preset.caption || (existingCaptionInput ? existingCaptionInput.value : '');
    // Build new inner content
    card.innerHTML = `
      <img src="${src}" alt="Photo">
      <input type="text" class="caption" placeholder="Caption" value="${existingCaption}">
      <div class="criteria-picker">
        ${buildCriteriaPanel(preset.criteria || [])}
      </div>
      <div class="controls-row">
        <button type="button" class="delete-photo">Delete photo</button>
      </div>
    `;
    // Wire up events
    const panel = card.querySelector('.criteria-panel');
    const tagsBox = card.querySelector('.criteria-tags');
    updateTags(panel, tagsBox);

    card.querySelector('.toggle-criteria').addEventListener('click', () => {
      panel.classList.toggle('open');
    });
    card.querySelector('.done-criteria').addEventListener('click', () => {
      panel.classList.remove('open');
      updateTags(panel, tagsBox);
    });
    card.querySelector('.clear-criteria').addEventListener('click', () => {
      panel.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false);
      updateTags(panel, tagsBox);
    });
    card.addEventListener('change', (e) => {
      if (e.target.matches('.criteria-panel input[type="checkbox"]')) {
        updateTags(panel, tagsBox);
      }
    });
    card.querySelector('.delete-photo').addEventListener('click', () => {
      if (confirm('Remove this photo?')) card.remove();
    });
  }

  // Enhance existing photo cards on load
  function enhanceAllExisting() {
    document.querySelectorAll('#photoContainer .photo-card').forEach(card => enhancePhotoCard(card));
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enhanceAllExisting);
  } else {
    enhanceAllExisting();
  }

  // Hook uploader to enhance new cards
  const uploader = document.getElementById('photoInput');
  if (uploader) {
    uploader.addEventListener('change', () => {
      setTimeout(enhanceAllExisting, 60);
    }, {capture:true});
  }

  // --- Upgrade Save/Load to include captions + selected criteria per photo ---
  const STORAGE_KEY_V3 = 'obs-report-unit102-v3';
  function collectDataV3() {
    const feedbackEl = document.getElementById('feedback') || document.querySelector('textarea');
    const sigCanvas = document.getElementById('signature');
    const cards = Array.from(document.querySelectorAll('#photoContainer .photo-card')).map(card => {
      const img = card.querySelector('img');
      const caption = card.querySelector('.caption') ? card.querySelector('.caption').value : '';
      const selected = Array.from(card.querySelectorAll('.criteria-panel input[type="checkbox"]:checked')).map(i => i.value);
      return { src: img ? img.src : '', caption, criteria: selected };
    });
    return {
      feedback: feedbackEl ? feedbackEl.value : '',
      signature: sigCanvas ? sigCanvas.toDataURL() : '',
      ticks: Array.from(document.querySelectorAll('input[type="checkbox"]')).map(cb => cb.checked),
      photos: cards
    };
  }

  function applyDataV3(data) {
    if (!data) return;
    const feedbackEl = document.getElementById('feedback') || document.querySelector('textarea');
    if (feedbackEl) feedbackEl.value = data.feedback || '';
    document.querySelectorAll('input[type="checkbox"]').forEach((cb,i)=>cb.checked = !!(data.ticks && data.ticks[i]));
    // Restore signature
    const sigCanvas = document.getElementById('signature');
    if (sigCanvas && data.signature) {
      const ctx = sigCanvas.getContext('2d');
      const img = new Image();
      img.onload = () => { ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height); ctx.drawImage(img,0,0); };
      img.src = data.signature;
    }
    // Restore photos
    const container = document.getElementById('photoContainer');
    if (container) {
      container.innerHTML = '';
      (data.photos || []).forEach(ph => {
        const div = document.createElement('div');
        div.className = 'photo-card';
        div.innerHTML = `<img src="${ph.src}" alt="Photo">`;
        container.appendChild(div);
        enhancePhotoCard(div, { caption: ph.caption || '', criteria: ph.criteria || [] });
      });
    }
  }

  // Rewire Save/Load/Clear buttons to use V3 format (with fallback)
  const saveBtn = document.getElementById('saveDraft');
  const loadBtn = document.getElementById('loadDraft');
  const clearBtn = document.getElementById('clearDraft');

  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
      try {
        localStorage.setItem(STORAGE_KEY_V3, JSON.stringify(collectDataV3()));
        alert('Draft saved locally — reopen this page later to continue.');
      } catch (err) {
        window.tempDraftV3 = collectDataV3();
        alert('Draft temporarily saved for this session — keep this tab open to retain changes.');
      }
    }, {capture:true});
  }
  if (loadBtn) {
    loadBtn.addEventListener('click', () => {
      let d = null;
      try {
        d = localStorage.getItem(STORAGE_KEY_V3);
      } catch(e){}
      if (d) {
        applyDataV3(JSON.parse(d));
        return;
      }
      // Fallback to older storage (photos as strings)
      try {
        const old = localStorage.getItem('obs-report-unit102');
        if (old) {
          const data = JSON.parse(old);
          data.photos = (data.photos || []).map(src => ({src, caption:'', criteria:[]}));
          applyDataV3(data);
        }
      } catch(e){}
    }, {capture:true});
  }
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      try { localStorage.removeItem(STORAGE_KEY_V3); } catch(e){}
      try { localStorage.removeItem('obs-report-unit102'); } catch(e){}
      alert('Draft cleared');
    }, {capture:true});
  }
})();
</script>
<style>
/* Multi-criteria picker UI */
.criteria-picker { margin-top: 8px; }
.criteria-panel { border: 1px solid #000; padding: 8px; margin-top: 6px; max-height: 220px; overflow: auto; display: none; background:#fff; }
.criteria-panel.open { display: block; }
.criteria-list label { display: block; margin-bottom: 4px; cursor: pointer; }
.criteria-tags { margin-top: 6px; display: flex; flex-wrap: wrap; gap: 6px; }
.criteria-tag { border: 1px solid #000; padding: 2px 6px; font-size: 12px; border-radius: 4px; }
.photo-card .controls-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
.criteria-filter { display:flex; gap:6px; margin-bottom:8px; }
.criteria-filter input { flex:1; padding:4px; border:1px solid #000; }
@media print {
  .criteria-panel, .toggle-criteria, .delete-photo { display:none !important; }
}
</style>
<script>
(function(){
  // --- Criteria catalogue (id + text) ---
  const CRITERIA = [
    {id:'1.1', text:'Identify which workplace health and safety procedures are relevant and comply with duties and obligations as defined by current legislation and organisational procedures'},
    {id:'1.2', text:'Produce a risk assessment and method statement in accordance with organisational procedures for a given work activity'},
    {id:'1.3a', text:'Risk assessments'},
    {id:'1.3b', text:'Method statements'},
    {id:'1.3c', text:'Safe systems of work'},
    {id:'2.1', text:'Identify unsafe situations and conditions and take remedial actions'},
    {id:'2.2a', text:'Materials'},
    {id:'2.2b', text:'Tools'},
    {id:'2.2c', text:'Equipment'},
    {id:'2.3', text:'Identify any high-risk hazards and report to relevant persons responsible for H&S'},
    {id:'2.4', text:'Apply measures to control health and safety hazards'},
    {id:'2.5', text:'Select and use correct Personal Protective Equipment'},
    {id:'3.1', text:'Demonstrate conduct/behaviour so H&S of self and others is not endangered'},
    {id:'3.2a', text:'Workplace policies (company and site)'},
    {id:'3.2b', text:'Supplier information'},
    {id:'3.2c', text:"Manufacturer's instructions"},
    {id:'3.3', text:'Comply with hazard warning, mandatory instruction and prohibition notices'},
    {id:'3.4', text:'Ensure safety of work location through correct use of guards, barriers, and notices'},
    {id:'3.5a', text:'Ladder'},
    {id:'3.5b', text:'Tower scaffold or MEWP'},
    {id:'3.5c', text:'Stepladder'},
    {id:'3.5d', text:'Platform'},
    {id:'4.1a', text:'Environmental Protection Act'},
    {id:'4.1b', text:'Hazardous Waste Regulations'},
    {id:'4.1c', text:'Pollution Prevention & Control Act'},
    {id:'4.1d', text:'Control of Pollution Act'},
    {id:'4.1e', text:'Control of Noise at Work Regulations'},
    {id:'4.1f', text:'Environmental Act'}
  ];

  // Build the multi-select panel HTML
  function buildCriteriaPanel(selected=[]) {
    const list = CRITERIA.map(c => {
      const chk = selected.includes(c.id) ? 'checked' : '';
      return `<label><input type="checkbox" value="${c.id}" ${chk}> ${c.id} – ${c.text}</label>`;
    }).join('');
    return `
      <div class="criteria-actions">
        <button type="button" class="toggle-criteria">Select criteria</button>
        <span class="criteria-hint" style="font-size:12px;">Tick all that apply</span>
      </div>
      <div class="criteria-panel">
        <div class="criteria-filter">
          <input type="text" class="criteria-search" placeholder="Search criteria...">
          <button type="button" class="criteria-select-all">Select all</button>
        </div>
        <div class="criteria-list">${list}</div>
        <div class="criteria-actions">
          <button type="button" class="done-criteria">Done</button>
          <button type="button" class="clear-criteria">Clear</button>
        </div>
      </div>
      <div class="criteria-tags"></div>
    `;
  }

  function updateTags(panel, tagsBox) {
    const sel = Array.from(panel.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
    const items = sel.map(id => {
      const c = CRITERIA.find(x => x.id === id);
      return `<span class="criteria-tag">${id} – ${c ? c.text : ''}</span>`;
    }).join('');
    tagsBox.innerHTML = items;
  }

  function wirePanelBehaviour(card) {
    const panel = card.querySelector('.criteria-panel');
    const tagsBox = card.querySelector('.criteria-tags');
    const search = panel.querySelector('.criteria-search');
    const selectAll = panel.querySelector('.criteria-select-all');

    // Toggle open/close
    card.querySelector('.toggle-criteria').addEventListener('click', () => {
      panel.classList.toggle('open');
      search && search.focus();
    });

    // Done / Clear
    card.querySelector('.done-criteria').addEventListener('click', () => {
      panel.classList.remove('open');
      updateTags(panel, tagsBox);
    });
    card.querySelector('.clear-criteria').addEventListener('click', () => {
      panel.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false);
      updateTags(panel, tagsBox);
    });

    // Live filter
    search.addEventListener('input', () => {
      const q = search.value.toLowerCase();
      panel.querySelectorAll('.criteria-list label').forEach(lbl => {
        const t = lbl.textContent.toLowerCase();
        lbl.style.display = t.includes(q) ? '' : 'none';
      });
    });

    // Select all visible
    selectAll.addEventListener('click', () => {
      panel.querySelectorAll('.criteria-list label').forEach(lbl => {
        if (lbl.style.display !== 'none') {
          const cb = lbl.querySelector('input[type="checkbox"]');
          if (cb) cb.checked = true;
        }
      });
      panel.dispatchEvent(new Event('change', {bubbles:true}));
    });

    // Update tags as boxes tick/untick
    panel.addEventListener('change', (e) => {
      if (e.target && e.target.type === 'checkbox') updateTags(panel, tagsBox);
    });

    // Initial tag render
    updateTags(panel, tagsBox);
  }

  function createEnhancedPhotoCard(src, caption='', selected=[]) {
    const div = document.createElement('div');
    div.className = 'photo-card';
    div.innerHTML = `
      <img src="${src}" alt="Photo">
      <input type="text" class="caption" placeholder="Caption" value="${caption}">
      <div class="criteria-picker">${buildCriteriaPanel(selected)}</div>
      <div class="controls-row"><button type="button" class="delete-photo">Delete photo</button></div>
    `;
    wirePanelBehaviour(div);
    div.querySelector('.delete-photo').addEventListener('click', () => {
      if (confirm('Remove this photo?')) div.remove();
    });
    return div;
  }

  // Upgrade any existing simple photo-cards to enhanced ones
  function upgradeExistingCards() {
    const container = document.getElementById('photoContainer');
    if (!container) return;
    const cards = Array.from(container.querySelectorAll('.photo-card'));
    cards.forEach(card => {
      if (card.__enhanced) return;
      const img = card.querySelector('img');
      const existingCaptionInput = card.querySelector('input[type="text"]');
      const caption = existingCaptionInput ? existingCaptionInput.value : '';
      const src = img ? img.src : '';
      const enhanced = createEnhancedPhotoCard(src, caption, []);
      card.replaceWith(enhanced);
      enhanced.__enhanced = True;
    });
  }

  // Replace/augment the uploader to create enhanced cards directly
  (function overrideUploader(){
    const input = document.getElementById('photoInput');
    const container = document.getElementById('photoContainer');
    if (!input || !container) return;
    input.addEventListener('change', function handleFiles(e){
      const files = Array.from(e.target.files || []);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = ev => {
          const card = createEnhancedPhotoCard(ev.target.result, '', []);
          container.appendChild(card);
        };
        reader.readAsDataURL(file);
      });
      // Clear input so same file can be added again if needed
      input.value = '';
    }, {capture:true});
  })();

  // Force trim of extra checkbox columns (keep exactly 3: Obs/WT/PE)
  (function trimTicks(){
    const tables = document.querySelectorAll('.criteria-table');
    tables.forEach(tbl => {
      tbl.querySelectorAll('th').forEach(th => {
        if ((th.textContent || '').toLowerCase().includes('otj')) th.remove();
      });
      tbl.querySelectorAll('tr').forEach(tr => {
        const cells = Array.from(tr.children);
        const cbCells = cells.filter(td => td.querySelector && td.querySelector('input[type="checkbox"]'));
        if (cbCells.length > 3) {
          const extras = cbCells.slice(0, cbCells.length - 3);
          extras.forEach(td => td.remove());
        }
      });
    });
  })();

  // Storage v3 includes captions + selected criteria
  const STORAGE_KEY_V3 = 'obs-report-unit102-v3';
  function collectDataV3() {
    const feedbackEl = document.getElementById('feedback') || document.querySelector('textarea');
    const sigCanvas = document.getElementById('signature');
    const photos = Array.from(document.querySelectorAll('#photoContainer .photo-card')).map(card => {
      const img = card.querySelector('img');
      const caption = card.querySelector('.caption') ? card.querySelector('.caption').value : '';
      const selected = Array.from(card.querySelectorAll('.criteria-panel input[type="checkbox"]:checked')).map(i => i.value);
      return { src: img ? img.src : '', caption, criteria: selected };
    });
    return {
      feedback: feedbackEl ? feedbackEl.value : '',
      signature: sigCanvas ? sigCanvas.toDataURL() : '',
      ticks: Array.from(document.querySelectorAll('input[type="checkbox"]')).map(cb => cb.checked),
      photos
    };
  }
  function applyDataV3(data) {
    if (!data) return;
    const feedbackEl = document.getElementById('feedback') || document.querySelector('textarea');
    if (feedbackEl) feedbackEl.value = data.feedback || '';
    document.querySelectorAll('input[type="checkbox"]').forEach((cb,i)=>cb.checked = !!(data.ticks && data.ticks[i]));
    // signature
    const sigCanvas = document.getElementById('signature');
    if (sigCanvas && data.signature) {
      const ctx = sigCanvas.getContext('2d');
      const img = new Image();
      img.onload = () => { ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height); ctx.drawImage(img,0,0); };
      img.src = data.signature;
    }
    // photos
    const container = document.getElementById('photoContainer');
    if (container) {
      container.innerHTML = '';
      (data.photos || []).forEach(ph => {
        const card = createEnhancedPhotoCard(ph.src, ph.caption || '', ph.criteria || []);
        container.appendChild(card);
      });
    }
  }

  // Rewire Save/Load/Clear to V3 with iPad-safe alerts
  function bindStorageButtons(){
    const saveBtn = document.getElementById('saveDraft');
    const loadBtn = document.getElementById('loadDraft');
    const clearBtn = document.getElementById('clearDraft');
    if (saveBtn) saveBtn.addEventListener('click', () => {
      try {
        localStorage.setItem(STORAGE_KEY_V3, JSON.stringify(collectDataV3()));
        alert('Draft saved locally — reopen this page later to continue.');
      } catch (err) {
        window.tempDraftV3 = collectDataV3();
        alert('Draft temporarily saved for this session — keep this tab open to retain changes.');
      }
    }, {capture:true});
    if (loadBtn) loadBtn.addEventListener('click', () => {
      let d = null;
      try { d = localStorage.getItem(STORAGE_KEY_V3); } catch(e){}
      if (d) { applyDataV3(JSON.parse(d)); return; }
      try {
        const old = localStorage.getItem('obs-report-unit102');
        if (old) {
          const data = JSON.parse(old);
          data.photos = (data.photos || []).map(src => ({src, caption:'', criteria:[]}));
          applyDataV3(data);
        }
      } catch(e){}
    }, {capture:true});
    if (clearBtn) clearBtn.addEventListener('click', () => {
      try { localStorage.removeItem(STORAGE_KEY_V3); } catch(e){}
      try { localStorage.removeItem('obs-report-unit102'); } catch(e){}
      alert('Draft cleared');
    }, {capture:true});
  }

  // Start
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { upgradeExistingCards(); bindStorageButtons(); });
  } else {
    upgradeExistingCards(); bindStorageButtons();
  }
})();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('./sw.js').catch(function (err) {
      console.log('SW registration failed:', err);
    });
  });
}
</script>
</body>
</html>
